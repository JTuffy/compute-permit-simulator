"""Chart components for simulation analysis."""

import solara
from matplotlib.figure import Figure
from compute_permit_sim.core.constants import CHART_COLOR_MAP, ColumnNames
from compute_permit_sim.vis.plotting import plot_scatter


@solara.component
def QuantitativeScatterPlot(agents_df):
    """Scatter plot of Reported (X) vs True (Y) compute for risk analysis."""
    if agents_df is None or agents_df.empty:
        solara.Markdown("No data for scatter plot.")
        return

    fig, ax = plot_scatter(
        agents_df,
        ColumnNames.REPORTED_COMPUTE,
        ColumnNames.USED_COMPUTE,
        "Risk Design: True vs Reported",
        "Reported Compute (r)",
        "True Compute (q)",
        color_logic="compliance",
    )

    max_val = (
        max(
            agents_df[ColumnNames.USED_COMPUTE].max(),
            agents_df[ColumnNames.REPORTED_COMPUTE].max(),
        )
        if not agents_df.empty
        else 1.0
    )
    ax.plot([0, max_val], [0, max_val], "k--", alpha=0.5, label="Honesty (y=x)")
    ax.legend()

    solara.FigureMatplotlib(fig)


@solara.component
def AuditTargetingPlot(agents_df):
    """Bar chart showing audit rates by compliance status."""
    if agents_df is None or agents_df.empty:
        solara.Markdown("No data for audit targeting plot.")
        return

    required_cols = [ColumnNames.IS_COMPLIANT, ColumnNames.WAS_AUDITED]
    if not all(col in agents_df.columns for col in required_cols):
        solara.Markdown("Missing required columns for audit plot.")
        return

    compliant_agents = agents_df[agents_df[ColumnNames.IS_COMPLIANT]]
    noncompliant_agents = agents_df[~agents_df[ColumnNames.IS_COMPLIANT]]

    compliant_audit_rate = (
        compliant_agents[ColumnNames.WAS_AUDITED].mean()
        if len(compliant_agents) > 0
        else 0
    )
    noncompliant_audit_rate = (
        noncompliant_agents[ColumnNames.WAS_AUDITED].mean()
        if len(noncompliant_agents) > 0
        else 0
    )

    fig = Figure(figsize=(5, 4))
    ax = fig.subplots()

    categories = ["Compliant", "Non-Compliant"]
    rates = [compliant_audit_rate * 100, noncompliant_audit_rate * 100]
    colors = ["#4CAF50", "#F44336"]

    bars = ax.bar(categories, rates, color=colors, alpha=0.8, edgecolor="black")

    for bar, rate in zip(bars, rates):
        ax.text(
            bar.get_x() + bar.get_width() / 2,
            bar.get_height() + 1,
            f"{rate:.1f}%",
            ha="center",
            va="bottom",
            fontsize=10,
            fontweight="bold",
        )

    ax.set_ylabel("Audit Rate (%)")
    ax.set_title("Audit Targeting Effectiveness")
    ax.set_ylim(0, max(rates) * 1.2 if max(rates) > 0 else 10)
    ax.grid(True, alpha=0.3, axis="y")

    n_compliant = len(compliant_agents)
    n_noncompliant = len(noncompliant_agents)
    ax.text(
        0.02,
        0.98,
        f"n={n_compliant} compliant, {n_noncompliant} non-compliant",
        transform=ax.transAxes,
        fontsize=8,
        verticalalignment="top",
        alpha=0.7,
    )
    fig.tight_layout()
    solara.FigureMatplotlib(fig)


@solara.component
def PayoffByStrategyPlot(agents_df):
    """Bar chart comparing average net value by strategy outcome."""
    if agents_df is None or agents_df.empty:
        solara.Markdown("No data for payoff plot.")
        return

    required_cols = [
        ColumnNames.IS_COMPLIANT,
        ColumnNames.WAS_CAUGHT,
        ColumnNames.STEP_PROFIT,
    ]
    if not all(col in agents_df.columns for col in required_cols):
        solara.Markdown("Missing required columns for payoff plot.")
        return

    compliant = agents_df[agents_df[ColumnNames.IS_COMPLIANT]]
    cheated_caught = agents_df[
        ~agents_df[ColumnNames.IS_COMPLIANT] & agents_df[ColumnNames.WAS_CAUGHT]
    ]
    cheated_uncaught = agents_df[
        ~agents_df[ColumnNames.IS_COMPLIANT] & ~agents_df[ColumnNames.WAS_CAUGHT]
    ]

    avg_compliant = (
        compliant[ColumnNames.STEP_PROFIT].mean() if len(compliant) > 0 else 0
    )
    avg_caught = (
        cheated_caught[ColumnNames.STEP_PROFIT].mean() if len(cheated_caught) > 0 else 0
    )
    avg_uncaught = (
        cheated_uncaught[ColumnNames.STEP_PROFIT].mean()
        if len(cheated_uncaught) > 0
        else 0
    )

    fig = Figure(figsize=(5, 4))
    ax = fig.subplots()

    categories = ["Compliant", "Caught", "Uncaught"]
    payoffs = [avg_compliant, avg_caught, avg_uncaught]
    colors = ["#4CAF50", "#000000", "#F44336"]
    counts = [len(compliant), len(cheated_caught), len(cheated_uncaught)]

    bars = ax.bar(categories, payoffs, color=colors, alpha=0.8, edgecolor="black")

    for bar, payoff, count in zip(bars, payoffs, counts):
        y_pos = bar.get_height()
        label_y = (
            y_pos + 0.02 * abs(max(payoffs) - min(payoffs))
            if y_pos >= 0
            else y_pos - 0.05 * abs(max(payoffs) - min(payoffs))
        )
        va = "bottom" if y_pos >= 0 else "top"
        ax.text(
            bar.get_x() + bar.get_width() / 2,
            label_y,
            f"${payoff:.2f}\n(n={count})",
            ha="center",
            va=va,
            fontsize=9,
            fontweight="bold",
        )

    ax.set_ylabel("Avg Net Value ($)")
    ax.set_title("Payoff by Strategy")
    ax.axhline(y=0, color="gray", linestyle="-", linewidth=0.5)
    ax.grid(True, alpha=0.3, axis="y")
    y_min = min(0, min(payoffs) * 1.3)
    y_max = max(payoffs) * 1.3 if max(payoffs) > 0 else 1
    ax.set_ylim(y_min, y_max)
    fig.tight_layout()
    solara.FigureMatplotlib(fig)


@solara.component
def LabDecisionPlot(agents_df, audit_prob: float, penalty: float):
    """Scatter plot of Economic Value vs Risk Profile with Deterrence Frontier."""
    import numpy as np

    if agents_df is None or agents_df.empty:
        solara.Markdown("No Agent Data")
        return

    required_cols = [
        ColumnNames.ECONOMIC_VALUE,
        ColumnNames.RISK_PROFILE,
        ColumnNames.IS_COMPLIANT,
    ]
    if not all(col in agents_df.columns for col in required_cols):
        solara.Markdown(
            "Missing data for decision plot (need economic_value/risk_profile)."
        )
        return

    fig = Figure(figsize=(6, 5), dpi=100)
    ax = fig.subplots()

    x = agents_df[ColumnNames.ECONOMIC_VALUE]
    y = agents_df[ColumnNames.RISK_PROFILE]
    colors = agents_df[ColumnNames.IS_COMPLIANT].map(
        {True: CHART_COLOR_MAP["green"], False: CHART_COLOR_MAP["red"]}
    )

    ax.scatter(x, y, c=colors, alpha=0.7, edgecolors="w", s=80)

    if penalty > 0 and audit_prob > 0:
        x_line = np.linspace(x.min(), x.max(), 100)
        y_line = x_line / (penalty * audit_prob)
        ax.plot(x_line, y_line, color="gray", linestyle="--", label="Indifference Line")

    ax.set_xlabel("Economic Value (Incentive)")
    ax.set_ylabel("Risk Profile (Sensitivity)")
    ax.set_title("Deterrence Frontier")
    ax.grid(True, alpha=0.3)
    ax.spines["top"].set_visible(False)
    ax.spines["right"].set_visible(False)
    ax.legend()
    solara.FigureMatplotlib(fig)


@solara.component
def WealthDivergencePlot(
    compliant_history: list[float], non_compliant_history: list[float]
):
    """Line chart showing Total Wealth of Compliant vs Non-Compliant agents over time."""
    if not compliant_history and not non_compliant_history:
        solara.Markdown("No Wealth Data")
        return

    fig = Figure(figsize=(8, 4), dpi=100)
    ax = fig.subplots()
    steps = list(range(1, len(compliant_history) + 1))

    ax.plot(
        steps,
        compliant_history,
        label="Compliant Total Wealth",
        color=CHART_COLOR_MAP["green"],
        linewidth=2.5,
        alpha=0.9,
    )
    ax.plot(
        steps,
        non_compliant_history,
        label="Non-Compliant Total Wealth",
        color=CHART_COLOR_MAP["red"],
        linewidth=2.5,
        alpha=0.9,
    )

    ax.set_xlabel("Step", fontsize=10)
    ax.set_ylabel("Total Wealth ($)", fontsize=10)
    ax.set_title("Wealth Divergence: Does Crime Pay?")
    ax.legend(loc="upper left")
    ax.grid(True, alpha=0.25, linestyle="--")
    ax.spines["top"].set_visible(False)
    ax.spines["right"].set_visible(False)
    fig.tight_layout()
    solara.FigureMatplotlib(fig)


@solara.component
def CheatingGainPlot(agents_df):
    """Scatter plot of Economic Value vs Step Profit."""
    if agents_df is None or agents_df.empty:
        solara.Markdown("No Agent Data")
        return

    required_cols = [
        ColumnNames.ECONOMIC_VALUE,
        ColumnNames.STEP_PROFIT,
        ColumnNames.IS_COMPLIANT,
    ]
    if not all(col in agents_df.columns for col in required_cols):
        solara.Markdown("Missing data for gain plot.")
        return

    fig = Figure(figsize=(6, 5), dpi=100)
    ax = fig.subplots()

    x = agents_df[ColumnNames.ECONOMIC_VALUE]
    y = agents_df[ColumnNames.STEP_PROFIT]
    colors = agents_df[ColumnNames.IS_COMPLIANT].map(
        {True: CHART_COLOR_MAP["green"], False: CHART_COLOR_MAP["red"]}
    )

    ax.scatter(x, y, c=colors, alpha=0.7, edgecolors="w", s=80)

    ax.set_xlabel("Economic Value (Potential)")
    ax.set_ylabel("Step Profit (Realized)")
    ax.set_title("Cheating Gain Analysis")
    ax.grid(True, alpha=0.3)
    ax.spines["top"].set_visible(False)
    ax.spines["right"].set_visible(False)
    solara.FigureMatplotlib(fig)


@solara.component
def CapacityUtilizationPlot(agents_df):
    """Scatter plot of Capacity vs Reported Compute."""
    if agents_df is None or agents_df.empty:
        solara.Markdown("No Agent Data")
        return

    required_cols = [
        ColumnNames.CAPACITY,
        ColumnNames.REPORTED_COMPUTE,
        ColumnNames.IS_COMPLIANT,
    ]
    if not all(col in agents_df.columns for col in required_cols):
        solara.Markdown("Missing data for capacity plot.")
        return

    fig = Figure(figsize=(6, 5), dpi=100)
    ax = fig.subplots()

    x = agents_df[ColumnNames.CAPACITY]
    y = agents_df[ColumnNames.REPORTED_COMPUTE]
    colors = agents_df[ColumnNames.IS_COMPLIANT].map(
        {True: CHART_COLOR_MAP["green"], False: CHART_COLOR_MAP["red"]}
    )

    ax.scatter(x, y, c=colors, alpha=0.7, edgecolors="w", s=80)

    max_val = max(x.max(), y.max()) if not x.empty else 1
    ax.plot([0, max_val], [0, max_val], "k--", alpha=0.3, label="100% Util Reported")

    ax.set_xlabel("Max Capacity (q_max)")
    ax.set_ylabel("Reported Compute (r)")
    ax.set_title("Reported Utilization vs Scale")
    ax.grid(True, alpha=0.3)
    ax.legend()
    ax.spines["top"].set_visible(False)
    ax.spines["right"].set_visible(False)
    solara.FigureMatplotlib(fig)
